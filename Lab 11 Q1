#include <stdio.h>
#include <string.h>
#include <stdlib.h>

int n;

struct students {
    char name[20];
    int rollno;
    float marks[3];
    float percentage;
    char grade[3];
    int rank;
};

void input(struct students std[], int n) {
    float Imarks, totalmarks;

    for(int i = 0; i < n; i++) {
        totalmarks = 0;

        int c;
        while ((c = getchar()) != '\n' && c != EOF);

        printf("Enter the name of Student %d: ", i + 1);
        fgets(std[i].name, sizeof(std[i].name), stdin);
        std[i].name[strcspn(std[i].name, "\n")] = '\0';

        printf("Enter the Roll no for Student %d: ", i + 1);
        scanf("%d", &std[i].rollno);

        for(int j = 0; j < 3; j++) {
            do {
                printf("Enter marks for Student %d of Subject %d: ", i + 1, j + 1);
                scanf("%f", &Imarks);
                if(Imarks >= 0 && Imarks <= 100) {
                    std[i].marks[j] = Imarks;
                    totalmarks += Imarks;
                    break;
                } else if(Imarks < 0) {
                    printf("Marks cannot be less than 0\n");
                } else {
                    printf("Marks cannot be greater than 100\n");
                }
            } while(1);
        }

        std[i].percentage = totalmarks / 3;
    }
}

void Grade(struct students std[], int n) {
    for(int i = 0; i < n; i++) {
        float p = std[i].percentage;
        if(p >= 90 && p <= 100) strcpy(std[i].grade, "A+");
        else if(p >= 80) strcpy(std[i].grade, "A");
        else if(p >= 70) strcpy(std[i].grade, "B+");
        else if(p >= 60) strcpy(std[i].grade, "B");
        else if(p >= 50) strcpy(std[i].grade, "C");
        else strcpy(std[i].grade, "F");
    }
}

void findrank(struct students std[], int n) {
    for(int i = 0; i < n; i++) {
        int rank = 1;
        for(int j = 0; j < n; j++) {
            if(std[j].percentage > std[i].percentage) {
                rank++;
            }
        }
        std[i].rank = rank;
    }
}

void findstd(struct students std[], int n) {
    int method, sindex = -1, roll;
    char search[20], sgrade[3];

    printf("\nSearch by:\n1. Name\n2. Roll Number\n3. Grade\nChoice: ");
    scanf("%d", &method);

    switch(method) {
        case 1: {
            int c; while ((c = getchar()) != '\n' && c != EOF); // flush
            printf("Enter the name to search: ");
            fgets(search, sizeof(search), stdin);
            search[strcspn(search, "\n")] = '\0';

            for(int i = 0; i < n; i++) {
                if(strcmp(search, std[i].name) == 0) {
                    sindex = i;
                    break;
                }
            }
            break;
        }

        case 2: {
            printf("Enter the Roll number to search: ");
            scanf("%d", &roll);
            for(int i = 0; i < n; i++) {
                if(roll == std[i].rollno) {
                    sindex = i;
                    break;
                }
            }
            break;
        }

        case 3: {
            int c; while ((c = getchar()) != '\n' && c != EOF); // flush
            printf("Enter the grade to search: ");
            fgets(sgrade, sizeof(sgrade), stdin);
            sgrade[strcspn(sgrade, "\n")] = '\0';

            for(int i = 0; i < n; i++) {
                if(strcmp(sgrade, std[i].grade) == 0) {
                    sindex = i;
                    break;
                }
            }
            break;
        }

        default: {
            printf("Invalid input!\n");
            return;
        }
    }

    if(sindex != -1) {
        printf("\n--- Student Found ---\n");
        printf("Name       : %s\n", std[sindex].name);
        printf("Roll No    : %d\n", std[sindex].rollno);
        printf("Percentage : %.2f\n", std[sindex].percentage);
        printf("Grade      : %s\n", std[sindex].grade);
        printf("Rank       : %d\n", std[sindex].rank);
    } else {
        printf("Student not found!\n");
    }
}

int main() {
    int menu = 1;

    printf("Enter the number of students: ");
    scanf("%d", &n);

    struct students *std = malloc(n * sizeof(struct students));

    printf("\n--- Enter Student Data ---\n");
    input(std, n);
    Grade(std, n);
    findrank(std, n);

    do {
        printf("\n--- MAIN MENU ---\n");
        printf("1. Find Student\n2. Exit\nChoice: ");
        scanf("%d", &menu);

        switch(menu) {
            case 1: findstd(std, n); break;
            case 2: menu = 0; break;
            default: printf("Invalid choice!\n"); break;
        }
    } while(menu);

    free(std);
    return 0;
}
